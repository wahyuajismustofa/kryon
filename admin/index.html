<!DOCTYPE html>
<html lang="id">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
	<title>Admin - Kryon</title>
	<meta name="description" content="Kryon adalah solusi percetakan terpercaya untuk semua kebutuhan Anda. Melayani cetak undangan, brosur, spanduk, kartu nama, dan merchandise custom dengan kualitas terbaik dan harga bersahabat.">
	<meta name="keywords" content="Kryon percetakan, jasa cetak terpercaya, solusi percetakan terbaik, percetakan berkualitas, percetakan murah, cepat">
	<meta name="author" content="Kryon">
	<meta name="robots" content="index, follow">
	<meta property="og:title" content="Admin - Kryon">
	<meta property="og:description" content="Kryon adalah solusi percetakan terpercaya untuk semua kebutuhan Anda. Melayani cetak undangan, brosur, spanduk, kartu nama, dan merchandise custom dengan kualitas terbaik dan harga bersahabat.">
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://www.karyaion.my.id/admin">
	<meta property="og:image" content="https://ik.imagekit.io/mustofa/web/img/logo-kryon-banner.png">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Admin - Kryon">
	<meta name="twitter:description" content="Kryon adalah solusi percetakan terpercaya untuk semua kebutuhan Anda. Melayani cetak undangan, brosur, spanduk, kartu nama, dan merchandise custom dengan kualitas terbaik dan harga bersahabat.">
	<meta name="twitter:image" content="https://ik.imagekit.io/mustofa/web/img/logo-kryon-banner.png">
	<link rel="icon" href="https://ik.imagekit.io/mustofa/web/img/logo-kryon-kotak.png" type="image/png">
	<link rel="apple-touch-icon" href="https://ik.imagekit.io/mustofa/web/img/logo-kryon-kotak.png">
	<meta name="theme-color" content="#ffffff">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .imp-hidden {
      display: none !important;
    }

    .logout-btn {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: crimson;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #main-container {
      display: flex;
      flex-wrap: wrap;
      min-height: 100vh;
      width: 100%;
    }

    #menu {
      background-color: #eee;
      transition: all 0.3s ease;
    }

    #konten {
      padding: 0;
    }
	#burger {
        display: block;
        background-color: #333;
        color: white;
        padding: 10px 15px;
        font-size: 18px;
        cursor: pointer;
      }

    @media (min-width: 501px) {
      #main-container {
        flex-direction: row;
        overflow: hidden;
      }
	  #burger {
        display:none;
      }
      #menu {
        width: 20%;
      }

      #konten {
        width: 80%;
        overflow-y: scroll;
      }
    }

    @media (max-width: 500px) {
      #main-container {
        flex-direction: column;
      }

      #menu {
        width: 100%;
      }

      #konten {
        width: 100%;
      }

      #burger {
        width:100%
      }

    }

    .menu-list {
      padding: 10px;
      cursor: pointer;
      margin-bottom: 5px;
      border-radius: 6px;
    }

    .menu-list:hover {
      background-color: #ddd;
    }

    .daftar-menu,
    .daftar-konten {
      padding: 20px;
    }
	 
    #loading-data {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fffb;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #ccc;
      border-top: 5px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }}
	
			#repo-size {
			font-size: 0.9em;
			color: #666;
		}

		.gallery {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
			gap: 5px;
		}

		.item {
			background: #eeeeeeee;
			padding: 5px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			text-align: center;
			transition: transform 0.2s ease;
			max-height: 100px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			justify-content: space-evenly;
			flex-wrap: nowrap;
		}

		.item:hover {
			transform: scale(1.03);
		}

		.item img {
			max-width: 100%;
			max-height: 70px;
			object-fit: cover;
			border-radius: 6px;
		}

		.filename {
			font-size: 0.9em;
			color: #333;
			word-break: break-word;
		}
		#upload-modal{
		position:fixed;
		inset:0;
		background:rgba(0,0,0,0.4);
		display:flex;
		align-items:center;
		justify-content:center;
		}
		.file-info {
	    display: flex;
	    flex-direction: row;
	    align-items: flex-start;
	    padding-bottom: 1.5em;
	    gap: 20px;
	}
	  button {
    background-color: #333;
    color: #FFF;
    padding: 5px 10px;
    border-radius: 10px;
    border: 1px solid #fff;
}

button:hover {
    color: #333;
    background-color: #fff;
    border: 1px solid #333;
}
  </style>
</head>
<body>
<div class="imp-hidden" id="loading-data"><div class="spinner"></div></div>
<div id="burger" onclick="toggleMenu()">‚ò∞ Menu</div>

<div id="main-container">
  <div id="menu">
    <div class="daftar-menu">
      <div class="menu-list" onclick="tampilKonten('akun')">Akun</div>
      <div class="menu-list" onclick="tampilKonten('galery')">Galery</div>
	  <div class="menu-list" onclick="window.location.href='/admin/resetpass.html'">Reset Password</div>
      <div class="menu-list"><a onclick="logout()">Keluar</a></div>
    </div>
  </div>

  <div id="konten">
    <div class="daftar-konten">
      <div id="konten-akun">
        <h2>Profil Pengguna</h2>
        <p><strong>Nama:</strong> <span id="nama"></span></p>
        <p><strong>WA:</strong> <span id="wa"></span></p>
        <p><strong>Website:</strong> <a id="link-web"><span id="web"></span></a></p>
		<p><strong>Google Sheet Produk: </strong><a id="googleSheetProduk">Buka Google Sheet</a></p>
		<p><strong>Google Sheet Setting: </strong><a id="googleSheetSetting">Buka Google Sheet</a></p>
		<div class="update-data">
		<button onclick='syncData()'>Update Data</button>
		<div id="status"><p>Data akan diperbarui setiap 24 jam sekali, atau kamu juga bisa update sekarang!</p></div>
		</div>
		
      </div>
      <div id="konten-galery" class="imp-hidden">
        <h2>Galeri</h2>
		<div class="file-info">
		<div id="repo-size">‚è≥ Mengambil ukuran repository...</div>
		<button id="open-upload">Upload File</button></div>
		<div class="gallery" id="gallery">
			<div>Memuat file...</div>
		</div>
		
		<div id="upload-modal" class="imp-hidden">
			<div style="background:white; padding:20px; border-radius:10px; max-width:500px; width:90%; position:relative;">
			<button id="close-modal" style="position:absolute; top:10px; right:10px;">X</button>
			<h3>Upload Gambar</h3>
			<input type="file" id="upload-input" multiple accept="image/*" />
			<button id="start-upload">Mulai Upload</button>
			<div id="upload-status" style="margin-top:1em; font-size:0.9em;"></div>
			</div>
		</div>

      </div>
    </div>
  </div>
</div>

<script>
let root = {};

window.addEventListener("DOMContentLoaded", async () => {
	root = await getRoot();
	if (!root?.repo) {
		document.getElementById("gallery").innerHTML = "‚ùå Konfigurasi repo tidak ditemukan.";
		return;
	}
	showRepoSize();
	fetchFiles();
});

//ambil data root
async function getRoot() {
	try {
		const response = await fetch("/root.json");
		if (!response.ok) throw new Error("Gagal mengambil data");
		return await response.json();
	} catch (err) {
		console.error("Error:", err.message);
		return {};
	}
}

//autentifikasi
  const token = localStorage.getItem("auth_token");
  const user = JSON.parse(localStorage.getItem("user"));
  const loading =document.getElementById("loading-data");
  const linksheet1 =document.getElementById("googleSheetProduk");
  const linksheet2 =document.getElementById("googleSheetSetting");
  
  linksheet1.href = user.sheetProduk;
  linksheet2.href = user.sheetSetting;

  if (!token || !user) {
    window.location.href = "login.html";
  } else {
    document.getElementById("nama").textContent = user.nama;
    document.getElementById("wa").textContent = user.wa;
    document.getElementById("web").textContent = user.domain;
	document.getElementById("link-web").href = "/";
  }

//logout
  function logout() {
    localStorage.removeItem("auth_token");
    localStorage.removeItem("user");
    window.location.href = "login.html";
  }

  function tampilKonten(target) {
    const semuaKonten = ['akun', 'galery'];
    semuaKonten.forEach(id => {
      document.getElementById(`konten-${id}`).classList.add("imp-hidden");
    });
    document.getElementById(`konten-${target}`).classList.remove("imp-hidden");

    if (window.innerWidth <= 500) {
      document.getElementById("menu").classList.add("imp-hidden");
    }
  }

  function toggleMenu() {
    const menu = document.getElementById("menu");
    menu.classList.toggle("imp-hidden");
  }

function formatSize(kb) {
	const mb = kb / 1024;
	const gb = mb / 1024;
	if (gb > 1) return gb.toFixed(2) + " GB";
	else if (mb > 1) return mb.toFixed(2) + " MB";
	else return kb + " KB";
}

async function showRepoSize() {
	const sizeEl = document.getElementById("repo-size");
	try {
		const res = await fetch(`https://api.github.com/repos/${root.mainRepo}/${root.repo}`);
		const data = await res.json();
		if (data.size !== undefined) {
			sizeEl.textContent = `üì¶ Ukuran repository: ${formatSize(data.size)}/1GB`;
		} else {
			sizeEl.textContent = "‚ùå Gagal mengambil ukuran repo.";
		}
	} catch (err) {
		sizeEl.textContent = "‚ùå Gagal memuat info repository.";
	}
}

async function fetchFiles() {
	const gallery = document.getElementById('gallery');
	gallery.innerHTML = '';

	try {
		const res = await fetch(`https://api.github.com/repos/${root.mainRepo}/${root.repo}/contents/src?ref=main`);
		const files = await res.json();

		if (!Array.isArray(files)) {
			gallery.innerHTML = `<div>‚ùå Gagal memuat file. Cek path atau API limit.</div>`;
			return;
		}

		files.forEach(file => {
			if (file.type === 'file') {
				const item = document.createElement('div');
				item.className = 'item';

				const link = document.createElement('a');
				const filename = file.download_url.split('/').pop();
				link.href = `/src/${filename}`;
				link.target = '_blank';

				const img = document.createElement('img');
				img.src = file.download_url;
				img.alt = file.name;
				img.onerror = () => {
					img.src = 'https://via.placeholder.com/150?text=File';
				};

				const name = document.createElement('div');
				name.className = 'filename';
				name.textContent = file.name;

				link.appendChild(img);
				item.appendChild(link);
				item.appendChild(name);
				gallery.appendChild(item);
			}
		});

	} catch (error) {
		console.error(error);
		gallery.innerHTML = `<div>‚ùå Terjadi kesalahan saat mengambil file.</div>`;
	}
}
document.getElementById("open-upload").addEventListener("click", () => {
	document.getElementById("upload-modal").classList.remove("imp-hidden");
});

document.getElementById("close-modal").addEventListener("click", () => {
	document.getElementById("upload-modal").classList.add("imp-hidden");
	document.getElementById("upload-status").innerHTML = "";
	document.getElementById("upload-input").value = "";
});

//fungsi upload
document.getElementById("start-upload").addEventListener("click", async () => {
	const input = document.getElementById("upload-input");
	const status = document.getElementById("upload-status");
	const files = Array.from(input.files);

	if (files.length === 0) {
		alert("Pilih file terlebih dahulu!");
		return;
	}

	status.innerHTML = "";

	for (let file of files) {
		const line = document.createElement("div");
		line.textContent = `‚è≥ Mengupload ${file.name}...`;
		status.appendChild(line);

		if (!file.type.startsWith("image/")) {
			line.textContent = `‚ùå ${file.name} bukan file gambar.`;
			continue;
		}

		try {
			const resized = await resizeImageIfNeeded(file, 500);
			const formData = new FormData();

			const res = await fetch("https://wam-kryon-api.vercel.app/api/repo", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({
				file: resized,
				mainRepo: root.mainRepo,
				repo: root.repo 
				})
			});

			const result = await res.json();

			if (res.ok) {
				line.innerHTML = `‚úÖ <a href="${result.url}" target="_blank">${file.name}</a> berhasil diupload.`;
			} else {
				line.textContent = `‚ùå ${file.name} gagal: ${result.message}`;
			}
		} catch (err) {
			line.textContent = `‚ùå ${file.name} error: ${err.message}`;
		}
	}
});

async function resizeImageIfNeeded(file, maxSize = 500) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    const img = new Image();

    reader.onload = (e) => {
      img.src = e.target.result;
    };

    img.onload = () => {
      const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
      const width = img.width * scale;
      const height = img.height * scale;

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      const base64 = canvas.toDataURL(file.type, 0.9); // ‚¨ÖÔ∏è hasil Base64
      resolve({ name: file.name, content: base64 });
    };

    img.onerror = () => reject(new Error("Gagal memuat gambar"));
    reader.onerror = () => reject(new Error("Gagal membaca file"));
    
    reader.readAsDataURL(file);
  });
}
//sinkron data
async function syncData() {
  try {
	document.getElementById("status").innerText = "Memproses...";
    const res1 = await fetch("https://wam-kryon-api.vercel.app/api/gaps-v1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ db: 'produk',repo:root.repo })
    });
	const res2 = await fetch("https://wam-kryon-api.vercel.app/api/gaps-v1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ db: 'setting',repo:root.repo })
    });
	

    const data1 = await res1.json();
	const data2 = await res2.json();

    if (res1.ok && res2.ok) {
      document.getElementById("status").innerText = "‚úÖ Data Setting dan Produk berhasil diperbarui.";
	} else {
      document.getElementById("status").innerText = "‚ùå Gagal memperbarui data: " + data.error;
    }
  } catch (error) {
    document.getElementById("status").innerText = "‚ùå Error saat melakukan sinkronisasi.";
    console.error(error);
  }
}
</script>

</body>
</html>
